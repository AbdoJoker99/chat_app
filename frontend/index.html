<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Chat App | A18 & A19</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .typing-dot { 
            animation: bounce 0.6s infinite;
            display: inline-block;
            width: 8px; height: 8px;
            margin: 0 1px;
            background-color: #4f46e5;
            border-radius: 50%;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.1s; }
        .typing-dot:nth-child(3) { animation-delay: 0.2s; }
        @keyframes bounce { 
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        #chat-container { max-height: 70vh; overflow-y: auto; scroll-behavior: smooth; }
        .status-dot { transition: background-color 0.3s ease; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app-container" class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
        
        <div id="view-container">
            
            <div id="auth-view" class="p-8 space-y-6">
                <h1 class="text-3xl font-bold text-center text-indigo-600">Welcome to Chat System</h1>
                
                <form id="register-form" class="space-y-4 border p-4 rounded-lg bg-gray-50">
                    <h2 class="text-xl font-semibold text-gray-700">Register New User</h2>
                    <input type="text" id="reg-username" placeholder="Username" required class="w-full p-3 border rounded-lg">
                    <input type="email" id="reg-email" placeholder="Email (e.g., user@test.com)" required class="w-full p-3 border rounded-lg">
                    <input type="password" id="reg-password" placeholder="Password (min 6 chars, A-a-1)" required class="w-full p-3 border rounded-lg">
                    <button type="submit" class="w-full p-3 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600">Register</button>
                    <p id="reg-status" class="text-sm text-red-500"></p>
                </form>

                <form id="login-form" class="space-y-4 border p-4 rounded-lg bg-gray-100">
                    <h2 class="text-xl font-semibold text-gray-700">Login</h2>
                    <input type="email" id="log-email" placeholder="Email" required class="w-full p-3 border rounded-lg">
                    <input type="password" id="log-password" placeholder="Password" required class="w-full p-3 border rounded-lg">
                    <button type="submit" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">Login</button>
                    <button type="button" id="google-login-btn" class="w-full p-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Login with Google (OAuth)</button>
                    <p id="log-status" class="text-sm text-red-500"></p>
                </form>

            </div>

            <div id="chat-view" class="hidden">
                <header class="p-4 bg-indigo-700 text-white flex justify-between items-center">
                    <h1 class="text-2xl font-bold">Live Chat Room</h1>
                    <div class="flex items-center space-x-4">
                        <div id="user-info" class="text-sm">
                            Welcome, <span id="client-username" class="font-semibold text-yellow-300"></span>
                        </div>
                        <button onclick="logout()" 
                                class="px-3 py-1 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                            Logout
                        </button>
                    </div>
                </header>

                <div class="flex">
                    <aside class="w-full md:w-1/4 p-4 border-r border-gray-200 bg-gray-100">
                        <h2 class="text-lg font-semibold mb-3 text-gray-700">Online Users</h2>
                        <ul id="online-users-list" class="space-y-2">
                            </ul>
                    </aside>
                    
                    <main class="w-full md:w-3/4 flex flex-col h-[70vh]">
                        
                        <div id="chat-container" class="flex-grow p-4 space-y-4">
                            <p class="text-center text-gray-500 italic" id="load-status">Loading messages...</p>
                        </div>

                        <div class="p-2 bg-white border-t" id="typing-status-bar">
                            <div id="typing-indicator" class="text-sm text-indigo-500 italic hidden">
                                <span id="typing-user" class="font-semibold">Someone</span> is typing
                                <span class="typing-dot"></span>
                                <span class="typing-dot"></span>
                                <span class="typing-dot"></span>
                            </div>
                        </div>

                        <form id="message-form" class="p-4 border-t border-gray-200 bg-white flex items-center space-x-2">
                            <input type="text" id="message-input" placeholder="Type a message..." required
                                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <button type="submit" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                                Send
                            </button>
                        </form>
                        <div id="mutation-error" class="text-red-500 text-xs px-4 pb-2 hidden"></div>
                    </main>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Configuration & Global State ---
        const NEST_API_URL = 'http://localhost:3000/api/v1'; // Base URL for NestJS API
        let socket = null;
        let USER_ID = localStorage.getItem('userId');
        let USERNAME = localStorage.getItem('username');
        let TOKEN = localStorage.getItem('accessToken');
        let TYPING_TIMEOUT;
        let IS_TYPING = false;

        // --- DOM Selectors ---
        const authView = document.getElementById('auth-view');
        const chatView = document.getElementById('chat-view');
        const regForm = document.getElementById('register-form');
        const logForm = document.getElementById('login-form');
        const msgForm = document.getElementById('message-form');
        const msgInput = document.getElementById('message-input');
        const chatContainer = document.getElementById('chat-container');
        const onlineUsersList = document.getElementById('online-users-list');
        const typingIndicator = document.getElementById('typing-indicator');
        const mutationError = document.getElementById('mutation-error');
        const regStatus = document.getElementById('reg-status');
        const logStatus = document.getElementById('log-status');


        // --- Utility Functions ---
        const scrollToBottom = () => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const updateLocalStorage = (token, id, username) => {
            localStorage.setItem('accessToken', token);
            localStorage.setItem('userId', id);
            localStorage.setItem('username', username);
            TOKEN = token;
            USER_ID = id;
            USERNAME = username;
        };

        const logout = () => {
            if (socket) socket.disconnect();
            localStorage.clear();
            window.location.reload();
        };
        window.logout = logout; // Expose to global scope

        const fetchGraphQL = async (query, variables = {}, customToken = TOKEN) => {
            const headers = { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${customToken}` 
            };
            
            const response = await fetch(`${NEST_API_URL}/graphql`, {
                method: 'POST',
                headers,
                body: JSON.stringify({ query, variables })
            });

            if (!response.ok) {
                if (response.status === 401) throw new Error("Session expired. Please log in again.");
                throw new Error("Network error or server error.");
            }
            
            const result = await response.json();
            if (result.errors) {
                const error = result.errors[0].message;
                throw new Error(error.includes("Validation Error") ? error.split(': ')[1] : error);
            }
            return result.data;
        };
        
        // --- UI Rendering ---

        const showView = (viewId) => {
            authView.classList.add('hidden');
            chatView.classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        };

        const appendMessage = (data) => {
            const isMe = data.sender.id === USER_ID;
            const msgTime = new Date(data.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
            
            messageElement.innerHTML = `
                <div class="max-w-xs px-4 py-2 rounded-xl shadow-sm ${isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'}">
                    <div class="font-semibold text-xs ${isMe ? 'text-indigo-200' : 'text-gray-500'}">${data.sender.username}</div>
                    <p class="text-sm">${data.text}</p>
                    <div class="text-xs text-right mt-1 ${isMe ? 'text-indigo-300' : 'text-gray-500'}">${msgTime}</div>
                </div>
            `;
            chatContainer.appendChild(messageElement);
            scrollToBottom();
        };

        // --- Socket.IO Handlers ---

        const initializeSocket = () => {
            if (!TOKEN) return;

            // Connect to NestJS WsGateway using JWT Token for Auth Guard
            socket = io(`${NEST_API_URL}/chat`, {
                autoConnect: true,
                auth: { token: TOKEN }
            });

            socket.on('connect', () => {
                console.log('Socket Connected.');
                document.getElementById('load-status').textContent = 'Fetching data...';
                document.getElementById('client-username').textContent = USERNAME;
                
                fetchChatData();
            });

            socket.on('connect_error', (err) => {
                if (err.message.includes("Authentication error")) {
                    console.error("Socket Auth Failed:", err.message);
                    logout();
                }
                document.getElementById('load-status').textContent = 'Connection failed. Attempting reconnect...';
            });

            socket.on('user_status_update', (data) => {
                // Update live users list when someone connects/disconnects
                updateOnlineUsers(data);
            });

            socket.on('typing_status', (data) => {
                if (data.isTyping) {
                    typingIndicator.classList.remove('hidden');
                    document.getElementById('typing-user').textContent = data.username;
                } else {
                    typingIndicator.classList.add('hidden');
                }
            });

            socket.on('chat_message', (data) => {
                // Receive message broadcasted from GraphQL Mutation after saving to DB
                appendMessage(data);
            });
        };
        
        // --- Chat Logic ---

        const fetchChatData = async () => {
            try {
                // 1. Fetch Online Users (GraphQL Query)
                const onlineQuery = `{ onlineUsers { id username isOnline } }`;
                const usersData = await fetchGraphQL(onlineQuery);
                usersData.onlineUsers.forEach(updateOnlineUsers);
                
                // 2. Fetch Historical Messages (GraphQL Query)
                const messageQuery = `{ messages { id text createdAt sender { id username } } }`;
                const messagesData = await fetchGraphQL(messageQuery);
                
                chatContainer.innerHTML = '';
                messagesData.messages.forEach(appendMessage);
                
                document.getElementById('load-status').remove();

            } catch (error) {
                console.error("Error fetching chat data:", error);
                chatContainer.innerHTML = `<p class="text-center text-red-500">Failed to load chat: ${error.message}</p>`;
                if (error.message.includes("Session expired")) logout();
            }
        };

        const updateOnlineUsers = (user) => {
            const isMe = user.id === USER_ID;
            let userElement = document.getElementById(`user-${user.id}`);
            const usernameDisplay = isMe ? `${user.username} (You)` : user.username;

            if (user.isOnline) {
                if (!userElement) {
                    userElement = document.createElement('li');
                    userElement.id = `user-${user.id}`;
                    userElement.className = 'flex items-center space-x-2 p-2 rounded-lg bg-white shadow-sm';
                    userElement.innerHTML = `
                        <span class="status-dot w-3 h-3 rounded-full ${isMe ? 'bg-indigo-500' : 'bg-green-500'}"></span>
                        <span class="username font-medium text-gray-700">${usernameDisplay}</span>
                    `;
                    // Prepend self, append others
                    if (isMe) {
                        onlineUsersList.prepend(userElement);
                    } else {
                        onlineUsersList.appendChild(userElement);
                    }
                }
            } else {
                if (userElement && !isMe) {
                    userElement.remove();
                }
            }
        };
        
        // --- Event Listeners ---

        // Authentication Handlers
        const handleAuthResponse = (response) => {
            if (response.success) {
                updateLocalStorage(response.accessToken, response.id, response.username);
                window.location.reload(); // Refresh to show chat view
            } else {
                regStatus.textContent = logStatus.textContent = response.message;
            }
        };

        regForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                username: document.getElementById('reg-username').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value,
            };
            try {
                const response = await fetch(`${NEST_API_URL}/auth/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                handleAuthResponse(await response.json());
            } catch (err) { regStatus.textContent = 'Server error.'; }
        });

        logForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                email: document.getElementById('log-email').value,
                password: document.getElementById('log-password').value,
            };
            try {
                const response = await fetch(`${NEST_API_URL}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                handleAuthResponse(await response.json());
            } catch (err) { logStatus.textContent = 'Server error.'; }
        });

        // Chat Handlers (GraphQL Mutation)
        msgForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = msgInput.value.trim();
            mutationError.classList.add('hidden');

            if (!text) return;

            const mutation = `
                mutation SendMessage($content: String!) {
                    sendMessage(content: $content) {
                        id
                        text
                    }
                }
            `;
            
            try {
                // Send message via GraphQL Mutation (NestJS Resolver handles Zod validation and broadcasting via Gateway)
                await fetchGraphQL(mutation, { content: text });
                
                msgInput.value = '';
                socket.emit('typing_stop', { userId: USER_ID });
                IS_TYPING = false;
            } catch (error) {
                mutationError.textContent = `Error: ${error.message}`;
                mutationError.classList.remove('hidden');
            }
        });

        // Typing Indicator Handlers (Socket.IO Events)
        msgInput.addEventListener('input', () => {
            clearTimeout(TYPING_TIMEOUT);
            if (!IS_TYPING) {
                socket.emit('typing_start', { userId: USER_ID });
                IS_TYPING = true;
            }
            TYPING_TIMEOUT = setTimeout(() => {
                socket.emit('typing_stop', { userId: USER_ID });
                IS_TYPING = false;
            }, 1500);
        });


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (TOKEN && USER_ID) {
                showView('chat-view');
                initializeSocket();
            } else {
                showView('auth-view');
            }
        });
    </script>
</body>
</html>